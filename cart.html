<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gi·ªè h√†ng - C·ª≠a h√†ng L·ªòC HO√ÄI</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f9fdf5;
    color: #333;
    margin: 0; padding: 20px;
  }
  h1 {
    color: #7aba4d;
    text-align: center;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 15px;
  }
  th, td {
    border: 1px solid #ccc;
    padding: 8px;
    text-align: left;
  }
  th {
    background-color: #d9f2c7;
  }
  tfoot td {
    font-weight: bold;
    font-size: 1.1em;
  }
  .btn {
    background-color: #7aba4d;
    color: white;
    border: none;
    padding: 10px 20px;
    cursor: pointer;
    font-weight: bold;
    border-radius: 5px;
  }
  .btn:hover {
    background-color: #629b3e;
  }
  .btn-secondary {
    background-color: #ccc;
    color: #333;
    margin-right: 10px;
  }
  .btn-secondary:hover {
    background-color: #bbb;
  }
  .bottom-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  /* Popup ƒë·∫∑t h√†ng */
  #orderModal {
    display: none;
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    width: 90%;
    max-width: 400px;
    padding: 20px;
    box-shadow: 0 0 15px rgba(0,0,0,0.3);
    border-radius: 8px;
    z-index: 2000;
  }
  #orderModal.active {
    display: block;
  }
  #orderModal label {
    display: block;
    margin: 10px 0 5px;
  }
  #orderModal input, #orderModal textarea {
    width: 100%;
    padding: 8px;
    box-sizing: border-box;
  }
  #overlay {
    display: none;
    position: fixed;
    top:0; left:0; right:0; bottom:0;
    background: rgba(0,0,0,0.4);
    z-index: 1000;
  }
  #overlay.active {
    display: block;
  }
  /* Th√¥ng b√°o */
  #notification {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #7aba4d;
    color: white;
    padding: 15px 25px;
    border-radius: 10px;
    font-weight: bold;
    z-index: 3000;
    display: none;
  }
</style>
</head>
<body>

<h1>Gi·ªè h√†ng - C·ª≠a h√†ng L·ªòC HO√ÄI</h1>

<table id="cartTable">
  <thead>
    <tr>
      <th>T√™n s·∫£n ph·∫©m</th>
      <th>S·ªë l∆∞·ª£ng</th>
      <th>Gi√°</th>
      <th>Th√†nh ti·ªÅn</th>
      <th>X√≥a</th>
    </tr>
  </thead>
  <tbody>
    <!-- S·∫£n ph·∫©m trong gi·ªè s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y -->
  </tbody>
  <tfoot>
    <tr>
      <td colspan="3">Ph√≠ v·∫≠n chuy·ªÉn</td>
      <td id="shippingFee">0 ƒë</td>
      <td></td>
    </tr>
    <tr>
      <td colspan="3">T·ªïng c·ªông</td>
      <td id="totalPrice">0 ƒë</td>
      <td></td>
    </tr>
  </tfoot>
</table>

<div class="bottom-actions">
  <button class="btn btn-secondary" id="btnBack">Tr·ªü v·ªÅ</button>
  <button class="btn" id="btnOrder">ƒê·∫∑t h√†ng</button>
</div>

<!-- Popup ƒë·∫∑t h√†ng -->
<div id="overlay"></div>
<div id="orderModal">
  <h2>Nh·∫≠p th√¥ng tin ƒë·∫∑t h√†ng</h2>
  <form id="orderForm">
    <label for="fullName">H·ªç t√™n:</label>
    <input type="text" id="fullName" required />
    <label for="phone">S·ªë ƒëi·ªán tho·∫°i:</label>
    <input type="tel" id="phone" required pattern="[0-9+ -]{7,15}" />
    <label for="address">ƒê·ªãa ch·ªâ:</label>
    <textarea id="address" rows="3" required></textarea>
    <div style="margin-top:15px; text-align:right;">
      <button type="button" class="btn btn-secondary" id="btnCancel">H·ªßy</button>
      <button type="submit" class="btn">ƒê·∫∑t h√†ng</button>
    </div>
  </form>
</div>

<!-- Th√¥ng b√°o -->
<div id="notification"></div>

<script>
  const API_TOKEN = '7986532916:AAGPbxtqJHILVuHBYb0fwsKU62a4jEJ8Jp8'; // Bot token
  const CHAT_ID = '7774024453'; // Chat ID c·ªßa b·∫°n

  const shippingFeeElement = document.getElementById('shippingFee');
  const totalPriceElement = document.getElementById('totalPrice');
  const cartTableBody = document.querySelector('#cartTable tbody');
  const btnBack = document.getElementById('btnBack');
  const btnOrder = document.getElementById('btnOrder');
  const orderModal = document.getElementById('orderModal');
  const overlay = document.getElementById('overlay');
  const orderForm = document.getElementById('orderForm');
  const notification = document.getElementById('notification');

  // M·∫£ng s·∫£n ph·∫©m m·∫´u gi·ªëng trang index ƒë·ªÉ l·∫•y th√¥ng tin t√™n, gi√°
  // B·∫°n c√≥ th·ªÉ l·∫•y d·ªØ li·ªáu n√†y t·ª´ server ho·∫∑c localStorage th·∫≠t
  const allProducts = [
    { id: '1', name: 'G·∫°o th∆°m', price: 40000 },
    { id: '2', name: 'Ti√™u xanh', price: 12000 },
    { id: '3', name: 'B√°nh quy Oreo', price: 25000 },
    { id: '4', name: 'Coca-Cola', price: 15000 },
    { id: '5', name: 'D·∫ßu g·ªôi Dove', price: 60000 },
    { id: '6', name: 'Thu·ªëc l√° Jet', price: 22000 },
    { id: '7', name: 'M·ª±c kh√¥', price: 120000 },
    { id: '101', name: 'N·ªìi c∆°m ƒëi·ªán Sunhouse', price: 1200000 },
    { id: '102', name: 'Qu·∫°t ƒëi·ªán', price: 350000 },
    { id: '103', name: 'Ch·∫£o ch·ªëng d√≠nh', price: 400000 },
    { id: '104', name: 'B·ªô ch√©n b√°t', price: 500000 },
    { id: '105', name: 'M√°y h√∫t b·ª•i', price: 1800000 },
  ];

  // L·∫•y gi·ªè h√†ng t·ª´ localStorage
  function getCart() {
    return JSON.parse(localStorage.getItem('cart')) || {};
  }
  function saveCart(cart) {
    localStorage.setItem('cart', JSON.stringify(cart));
  }

  // L·∫•y th√¥ng tin s·∫£n ph·∫©m theo id
  function getProductInfo(id) {
    return allProducts.find(p => p.id === id);
  }

  // Hi·ªÉn th·ªã gi·ªè h√†ng l√™n b·∫£ng
  function renderCart() {
    const cart = getCart();
    cartTableBody.innerHTML = '';
    let subtotal = 0;

    if (Object.keys(cart).length === 0) {
      cartTableBody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding: 20px;">Gi·ªè h√†ng tr·ªëng.</td></tr>`;
      shippingFeeElement.textContent = '0 ƒë';
      totalPriceElement.textContent = '0 ƒë';
      btnOrder.disabled = true;
      return;
    } else {
      btnOrder.disabled = false;
    }

    for (const productId in cart) {
      const quantity = cart[productId];
      const product = getProductInfo(productId);
      if (!product) continue;
      const price = product.price;
      const total = price * quantity;
      subtotal += total;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${product.name}</td>
        <td>${quantity}</td>
        <td>${price.toLocaleString('vi-VN')} ƒë</td>
        <td>${total.toLocaleString('vi-VN')} ƒë</td>
        <td><button data-id="${productId}" class="btn btn-secondary btn-remove">X√≥a</button></td>
      `;
      cartTableBody.appendChild(tr);
    }

    // T√≠nh ph√≠ v·∫≠n chuy·ªÉn
    const shippingFee = subtotal >= 200000 ? 0 : 20000;
    shippingFeeElement.textContent = shippingFee.toLocaleString('vi-VN') + ' ƒë';

    // T·ªïng ti·ªÅn
    const total = subtotal + shippingFee;
    totalPriceElement.textContent = total.toLocaleString('vi-VN') + ' ƒë';

    // G√°n s·ª± ki·ªán x√≥a s·∫£n ph·∫©m
    document.querySelectorAll('.btn-remove').forEach(btn => {
      btn.onclick = () => {
        const id = btn.getAttribute('data-id');
        delete cart[id];
        saveCart(cart);
        renderCart();
      };
    });
  }

  // Hi·ªÉn th·ªã popup ƒë·∫∑t h√†ng
  function openOrderModal() {
    orderModal.classList.add('active');
    overlay.classList.add('active');
  }
  function closeOrderModal() {
    orderModal.classList.remove('active');
    overlay.classList.remove('active');
  }

  // Hi·ªÉn th·ªã th√¥ng b√°o ·ªü gi·ªØa m√†n h√¨nh
  function showNotification(message, success = true) {
    notification.textContent = message;
    notification.style.backgroundColor = success ? '#7aba4d' : '#d9534f';
    notification.style.display = 'block';
    setTimeout(() => {
      notification.style.display = 'none';
    }, 2000);
  }

  // T·∫°o m√£ ƒë∆°n h√†ng g·ªìm 3 ch·ªØ c√°i hoa + 7 s·ªë
  function generateOrderCode() {
    const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
    let code = '';
    for (let i = 0; i < 3; i++) {
      code += letters.charAt(Math.floor(Math.random() * letters.length));
    }
    for (let i = 0; i < 7; i++) {
      code += Math.floor(Math.random() * 10);
    }
    return code;
  }

  // G·ª≠i d·ªØ li·ªáu ƒë∆°n h√†ng l√™n Telegram bot
  async function sendOrderToTelegram(orderData) {
    const url = `https://api.telegram.org/bot${API_TOKEN}/sendMessage`;

    const text = 
`üì¶ ƒê∆†N H√ÄNG M·ªöI:
üïí Th·ªùi gian: ${orderData.time}
üë§ T√™n: ${orderData.fullName}
üìû SƒêT: ${orderData.phone}
üè† ƒê·ªãa ch·ªâ: ${orderData.address}

üõí S·∫£n ph·∫©m:
${orderData.products.map(p => `- ${p.name} x ${p.quantity}`).join('\n')}

üöö Ph√≠ ship: ${orderData.shippingFee.toLocaleString('vi-VN')}‚Ç´
üí∞ T·ªïng c·ªông: ${orderData.totalPrice.toLocaleString('vi-VN')} ƒë
M√£ ƒë∆°n h√†ng: ${orderData.orderCode}
`;

    try {
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          chat_id: CHAT_ID,
          text: text,
          parse_mode: 'Markdown'
        })
      });
      const data = await res.json();
      return data.ok;
    } catch (error) {
      return false;
    }
  }

  // X·ª≠ l√Ω g·ª≠i ƒë∆°n h√†ng
  orderForm.onsubmit = async (e) => {
    e.preventDefault();
    const fullName = document.getElementById('fullName').value.trim();
    const phone = document.getElementById('phone').value.trim();
    const address = document.getElementById('address').value.trim();

    if (!fullName || !phone || !address) {
      alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin.');
      return;
    }

    const cart = getCart();
    if (Object.keys(cart).length === 0) {
      alert('Gi·ªè h√†ng ƒëang tr·ªëng.');
      return;
    }

    // Chu·∫©n b·ªã d·ªØ li·ªáu ƒë∆°n h√†ng
    let subtotal = 0;
    const products = [];
    for (const id in cart) {
      const quantity = cart[id];
      const product = getProductInfo(id);
      if (!product) continue;
      products.push({ name: product.name, quantity: quantity });
      subtotal += product.price * quantity;
    }
    const shippingFee = subtotal >= 200000 ? 0 : 20000;
    const totalPrice = subtotal + shippingFee;

    const now = new Date();
    const timeStr = now.toLocaleTimeString('vi-VN') + ' - ' + now.toLocaleDateString('vi-VN');
    const orderCode = generateOrderCode();

    const orderData = {
      fullName,
      phone,
      address,
      products,
      shippingFee,
      totalPrice,
      time: timeStr,
      orderCode
    };

    btnOrder.disabled = true;

    const success = await sendOrderToTelegram(orderData);
    if (success) {
      showNotification('ƒê·∫∑t h√†ng th√†nh c√¥ng!');
      // X√≥a gi·ªè h√†ng
      localStorage.removeItem('cart');
      renderCart();
      closeOrderModal();
    } else {
      showNotification('ƒê·∫∑t h√†ng kh√¥ng th√†nh c√¥ng!', false);
    }
    btnOrder.disabled = false;
  };

  // N√∫t ƒë·∫∑t h√†ng
  btnOrder.onclick = () => {
    openOrderModal();
  };

  // N√∫t h·ªßy popup
  document.getElementById('btnCancel').onclick = () => {
    closeOrderModal();
  };

  // N√∫t overlay click c≈©ng ƒë√≥ng popup
  overlay.onclick = () => {
    closeOrderModal();
  };

  // N√∫t tr·ªü v·ªÅ
  btnBack.onclick = () => {
    window.history.back(); // ho·∫∑c window.location.href = 'index.html'; n·∫øu mu·ªën
  };

  // Kh·ªüi t·∫°o hi·ªÉn th·ªã
  renderCart();
</script>

</body>
</html>
