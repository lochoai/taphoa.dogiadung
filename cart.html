<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gi·ªè H√†ng - C·ª≠a H√†ng L·ªòC HO√ÄI</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

  <header>
    <div class="header-content">
      <div class="store-info">
        <h1>C·ª≠a H√†ng<br><span class="store-name">L·ªòC HO√ÄI</span></h1>
        <p>chuy√™n t·∫°p h√≥a, ƒë·ªì gia d·ª•ng</p>
      </div>
      <div class="contact-info">
        <a href="tel:0372057834"><img src="https://img.icons8.com/ios-filled/24/phone.png"/> 0372057834</a>
        <a href="https://facebook.com/pro.huuloc.1" target="_blank"><img src="https://img.icons8.com/ios-filled/24/facebook.png"/> Facebook</a>
        <a href="#"><img src="https://img.icons8.com/ios-filled/24/zalo.png"/> Zalo</a>
        <a href="https://t.me/7774024453" target="_blank"><img src="https://img.icons8.com/ios-filled/24/telegram-app.png"/> Telegram</a>
      </div>
    </div>
    <div class="cart-icon">
      <a href="cart.html"><img src="https://img.icons8.com/ios-filled/30/shopping-cart.png"/> Gi·ªè h√†ng</a>
    </div>
  </header>

  <main class="cart-main">
    <h2>Gi·ªè h√†ng c·ªßa b·∫°n</h2>
    <table class="cart-table">
      <thead>
        <tr>
          <th>S·∫£n ph·∫©m</th>
          <th>S·ªë l∆∞·ª£ng</th>
          <th>Gi√°</th>
          <th>Th√†nh ti·ªÅn</th>
          <th>X√≥a</th>
        </tr>
      </thead>
      <tbody id="cart-items">
        <!-- Danh s√°ch s·∫£n ph·∫©m s·∫Ω ƒë∆∞·ª£c JS th√™m v√†o -->
      </tbody>
    </table>

    <div class="cart-summary">
      <p>Ph√≠ v·∫≠n chuy·ªÉn: <span id="shipping-fee">20,000‚Ç´</span></p>
      <p>T·ªïng c·ªông: <span id="total-price">0‚Ç´</span></p>
    </div>

    <div class="cart-buttons">
      <button id="back-to-products">‚Üê Tr·ªü v·ªÅ</button>
      <button id="btn-checkout">ƒê·∫∑t h√†ng</button>
    </div>
  </main>

  <!-- Popup ƒë·∫∑t h√†ng -->
  <div id="order-modal" class="modal hidden">
    <div class="modal-content">
      <h3>Th√¥ng tin ƒë·∫∑t h√†ng</h3>
      <form id="order-form">
        <label for="customer-name">H·ªç t√™n:</label>
        <input type="text" id="customer-name" name="customerName" required />

        <label for="customer-phone">S·ªë ƒëi·ªán tho·∫°i:</label>
        <input type="tel" id="customer-phone" name="customerPhone" pattern="[0-9]{9,12}" required />

        <label for="customer-address">ƒê·ªãa ch·ªâ:</label>
        <textarea id="customer-address" name="customerAddress" rows="3" required></textarea>

        <div class="modal-buttons">
          <button type="button" id="cancel-order">H·ªßy</button>
          <button type="submit" id="submit-order">ƒê·∫∑t h√†ng</button>
        </div>
      </form>
    </div>
  </div>

  <script src="script.js"></script>
  <script>
    // Ph·∫ßn x·ª≠ l√Ω ri√™ng cho cart.html

    const CART_KEY = 'lochoai_cart';
    const SHIPPING_FEE = 20000;

    const cartItemsTbody = document.getElementById('cart-items');
    const totalPriceEl = document.getElementById('total-price');
    const shippingFeeEl = document.getElementById('shipping-fee');
    const backToProductsBtn = document.getElementById('back-to-products');
    const checkoutBtn = document.getElementById('btn-checkout');
    const orderModal = document.getElementById('order-modal');
    const orderForm = document.getElementById('order-form');
    const cancelOrderBtn = document.getElementById('cancel-order');

    // L·∫•y gi·ªè h√†ng t·ª´ localStorage
    function getCart() {
      const cart = localStorage.getItem(CART_KEY);
      return cart ? JSON.parse(cart) : [];
    }

    // L∆∞u gi·ªè h√†ng
    function saveCart(cart) {
      localStorage.setItem(CART_KEY, JSON.stringify(cart));
    }

    // Hi·ªÉn th·ªã gi·ªè h√†ng ra b·∫£ng
    function renderCart() {
      const cart = getCart();
      cartItemsTbody.innerHTML = '';
      if (cart.length === 0) {
        cartItemsTbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Gi·ªè h√†ng tr·ªëng</td></tr>';
        totalPriceEl.textContent = '0‚Ç´';
        shippingFeeEl.textContent = '0‚Ç´';
        return;
      }

      let total = 0;
      cart.forEach((item, index) => {
        const itemTotal = item.price * item.qty;
        total += itemTotal;

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${item.name}</td>
          <td>
            <input type="number" min="1" value="${item.qty}" data-index="${index}" class="qty-input" />
          </td>
          <td>${item.price.toLocaleString()}‚Ç´</td>
          <td>${itemTotal.toLocaleString()}‚Ç´</td>
          <td><button class="remove-item" data-index="${index}">X√≥a</button></td>
        `;
        cartItemsTbody.appendChild(tr);
      });

      const shippingFee = total >= 199999 ? 0 : SHIPPING_FEE;
      shippingFeeEl.textContent = shippingFee.toLocaleString() + '‚Ç´';

      totalPriceEl.textContent = (total + shippingFee).toLocaleString() + '‚Ç´';
    }

    // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng khi thay ƒë·ªïi input
    cartItemsTbody.addEventListener('change', (e) => {
      if (e.target.classList.contains('qty-input')) {
        const index = +e.target.dataset.index;
        let qty = parseInt(e.target.value);
        if (qty < 1 || isNaN(qty)) qty = 1;
        const cart = getCart();
        cart[index].qty = qty;
        saveCart(cart);
        renderCart();
      }
    });

    // X√≥a s·∫£n ph·∫©m
    cartItemsTbody.addEventListener('click', (e) => {
      if (e.target.classList.contains('remove-item')) {
        const index = +e.target.dataset.index;
        const cart = getCart();
        cart.splice(index, 1);
        saveCart(cart);
        renderCart();
      }
    });

    // N√∫t tr·ªü v·ªÅ trang s·∫£n ph·∫©m
    backToProductsBtn.onclick = () => {
      window.history.back();
    };

    // M·ªü popup ƒë·∫∑t h√†ng
    checkoutBtn.onclick = () => {
      const cart = getCart();
      if (cart.length === 0) {
        alert('Gi·ªè h√†ng tr·ªëng, vui l√≤ng ch·ªçn s·∫£n ph·∫©m tr∆∞·ªõc khi ƒë·∫∑t h√†ng.');
        return;
      }
      orderModal.classList.remove('hidden');
    };

    // ƒê√≥ng popup ƒë·∫∑t h√†ng
    cancelOrderBtn.onclick = () => {
      orderModal.classList.add('hidden');
    };

    // G·ª≠i ƒë∆°n h√†ng qua Telegram bot
    orderForm.onsubmit = async (e) => {
      e.preventDefault();

      const name = orderForm.customerName.value.trim();
      const phone = orderForm.customerPhone.value.trim();
      const address = orderForm.customerAddress.value.trim();
      const cart = getCart();

      if (!name || !phone || !address) {
        alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin.');
        return;
      }

      // T·∫°o m√£ ƒë∆°n h√†ng
      function randomOrderCode() {
        const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
        let code = '';
        for(let i = 0; i < 3; i++) {
          code += letters.charAt(Math.floor(Math.random() * letters.length));
        }
        code += Math.floor(1000000 + Math.random() * 9000000);
        return code;
      }

      const orderCode = randomOrderCode();

      // Th·ªùi gian hi·ªán t·∫°i
      const now = new Date();
      const timeStr = now.toLocaleTimeString('vi-VN');
      const dateStr = now.toLocaleDateString('vi-VN');

      // Chu·∫©n b·ªã danh s√°ch s·∫£n ph·∫©m
      let productList = '';
      cart.forEach(item => {
        productList += `- ${item.name} x ${item.qty}\n`;
      });

      // T√≠nh ph√≠ ship
      let total = 0;
      cart.forEach(item => {
        total += item.price * item.qty;
      });
      const shipFee = total >= 199999 ? 0 : SHIPPING_FEE;
      const totalAll = total + shipFee;

      // Tin nh·∫Øn g·ª≠i Telegram
      const message = encodeURIComponent(
`üì¶ ƒê∆†N H√ÄNG M·ªöI: ${orderCode}
üïí Th·ªùi gian: ${timeStr} - ${dateStr}
üë§ T√™n: ${name}
üìû SƒêT: ${phone}
üè† ƒê·ªãa ch·ªâ: ${address}

üõí S·∫£n ph·∫©m:
${productList}
üöö Ph√≠ ship: ${shipFee.toLocaleString()}‚Ç´
üí∞ T·ªïng c·ªông: ${totalAll.toLocaleString()} ƒë`
      );

      // Thay YOUR_BOT_TOKEN v√† CHAT_ID v√†o ƒë√¢y
      const BOT_TOKEN = '7986532916:AAGPbxtqJHILVuHBYb0fwsKU62a4jEJ8Jp8';
      const CHAT_ID = '7774024453';

      try {
        const res = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage?chat_id=${CHAT_ID}&text=${message}`);
        const data = await res.json();

        if (data.ok) {
          alert('ƒê·∫∑t h√†ng th√†nh c√¥ng! C·∫£m ∆°n b·∫°n.');
          // X√≥a gi·ªè h√†ng
          localStorage.removeItem(CART_KEY);
          orderModal.classList.add('hidden');
          renderCart();
          window.location.href = 'index.html'; // Quay l·∫°i trang s·∫£n ph·∫©m
        } else {
          alert('ƒê·∫∑t h√†ng kh√¥ng th√†nh c√¥ng, vui l√≤ng th·ª≠ l·∫°i.');
        }
      } catch (error) {
        alert('L·ªói khi g·ª≠i ƒë∆°n h√†ng, vui l√≤ng th·ª≠ l·∫°i.');
      }
    };

    // Render l·∫ßn ƒë·∫ßu
    renderCart();
  </script>

</body>
</html>
